<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Numbers Invaders</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root { --bg:#061126; --panel: rgba(0,0,0,0.45); }
html,body{height:100%;margin:0;font-family:monospace;background:linear-gradient(#041021,var(--bg));color:#fff;display:flex;align-items:center;justify-content:center}
#gameContainer{position:relative;width:640px;height:480px;max-width:96vw;max-height:96vh}
canvas{display:block;width:100%;height:100%;image-rendering:pixelated;border:4px solid #071225;background:var(--bg)}
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;pointer-events:none}
.title{font-size:26px;text-shadow:2px 2px 0 #000}
.small{font-size:14px;opacity:.95}
.button{pointer-events:auto;background:#c6ffe6;color:#033;border-radius:8px;padding:10px 18px;border:2px solid #033;cursor:pointer;font-weight:700}
.scoreBox,.questionBox,.bestBox{position:absolute;top:8px;padding:6px 8px;border-radius:6px;background:var(--panel);font-size:14px}
.scoreBox{left:8px}
.questionBox{right:8px}
.bestBox{left:8px;top:34px}
.controls{position:absolute;left:8px;right:8px;bottom:8px;display:flex;justify-content:space-between;pointer-events:none}
.ctrlBtn{pointer-events:auto;width:74px;height:46px;background:rgba(255,255,255,0.06);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
.hitFeedback{position:absolute;left:50%;top:45%;transform:translateX(-50%);font-size:20px;padding:6px 10px;border-radius:6px}
</style>
</head>
<body>
<div id="gameContainer">
  <canvas id="game" width="320" height="240"></canvas>

  <div class="overlay" id="startOverlay">
    <div class="title">Numbers Invaders</div>
    <div class="small">Atire no nÃºmero que Ã© o resultado da conta.<br>Acertou: +1 | Errou: -1</div>
    <button class="button" id="startBtn">ComeÃ§ar</button>
  </div>

  <div class="scoreBox" id="scoreBox">Score: 0</div>
  <div class="bestBox" id="bestBox">Melhor: 0</div>
  <div class="questionBox" id="questionBox">â€”</div>

  <div class="controls">
    <div class="ctrlBtn" id="leftBtn">â—€</div>
    <div style="flex:1"></div>
    <div class="ctrlBtn" id="shootBtn">FIRE</div>
    <div style="flex:1"></div>
    <div class="ctrlBtn" id="rightBtn">â–¶</div>
  </div>

  <div id="feedbackHolder"></div>
</div>

<script>
function createBeep(freq, duration, type="square", volume=0.1){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  gain.gain.value = volume;
  osc.connect(gain).connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + duration/1000);
}

function playShot(){ createBeep(600,100,"square",0.15); }
function playHit(){ createBeep(400,150,"triangle",0.2); }
function playMiss(){ createBeep(200,250,"sawtooth",0.2); }

let bgCtx;
function playMusic(){
  if(bgCtx) return;
  bgCtx = new (window.AudioContext||window.webkitAudioContext)();
  const notes = [261,329,392,523];
  let i=0;
  function loop(){
    const osc = bgCtx.createOscillator();
    const g = bgCtx.createGain();
    osc.type="sine";
    osc.frequency.value=notes[i%notes.length];
    g.gain.value=0.07;
    osc.connect(g).connect(bgCtx.destination);
    osc.start();
    osc.stop(bgCtx.currentTime+0.25);
    i++;
    setTimeout(loop,300);
  }
  loop();
}

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;
const W = canvas.width, H = canvas.height;

const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const scoreBox = document.getElementById('scoreBox');
const questionBox = document.getElementById('questionBox');
const bestBox = document.getElementById('bestBox');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const shootBtn = document.getElementById('shootBtn');
const feedbackHolder = document.getElementById('feedbackHolder');

let player = { x: W/2 - 10, y: H - 18, w: 20, h: 8, speed: 2.2 };
let bullets = [];
let blocks = [];
let score = 0;
let bestScore = parseInt(localStorage.getItem("bestScore")||"0");
let question = null;
let roundActive = false;
let lastShot = 0;
const WIN_SCORE = 10;
const LOSE_SCORE = -5;
const keys = { left:false, right:false };

function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function rectIntersect(a,b){ return !(a.x+a.w < b.x || a.x > b.x+b.w || a.y+a.h < b.y || a.y > b.y+b.h); }

function generateQuestion(){
  const ops = ['+','-'];
  const op = ops[randInt(0, ops.length-1)];
  let a,b;
  if(op === '+'){ a = randInt(0,9); b = randInt(0,9); }
  else { a = randInt(0,9); b = randInt(0,a); }
  const answer = op==='+'?a+b:a-b;
  return { a, b, op, answer, text: `${a} ${op} ${b} = ?` };
}

function generateOptions(answer, count=4){
  const s = new Set([answer]);
  while(s.size<count){
    const delta=randInt(-4,4);
    let c=answer+delta;
    if(c<0) c=Math.abs(c);
    if(c!==answer) s.add(c);
  }
  const arr=[...s];
  for(let i=arr.length-1;i>0;i--){
    const j=randInt(0,i); [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function spawnNextRound(){
  blocks.length=0;
  question=generateQuestion();
  const options=generateOptions(question.answer,4);
  const spacing=W/options.length;
  for(let i=0;i<options.length;i++){
    const bw=32,bh=18;
    const x=Math.floor(spacing*i+(spacing-bw)/2+randInt(-6,6));
    const y=randInt(6,26);
    blocks.push({x,y,w:bw,h:bh,val:options[i],vy:0.3+Math.random()*0.45});
  }
  roundActive=true;
  updateUI();
}

function updateUI(){
  scoreBox.innerText=`Score: ${score}`;
  bestBox.innerText=`Melhor: ${bestScore}`;
  questionBox.innerText= question ? question.text : 'â€”';
}

function showFeedback(text,color='#9df',duration=700){
  const el=document.createElement('div');
  el.className='hitFeedback';
  el.style.background='rgba(0,0,0,0.6)';
  el.style.color=color;
  el.innerText=text;
  feedbackHolder.appendChild(el);
  setTimeout(()=>el.remove(),duration);
}

document.addEventListener('keydown', e=>{
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=true;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=true;
  if(e.key===' '){ e.preventDefault(); shoot(); }
});
document.addEventListener('keyup', e=>{
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=false;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=false;
});
canvas.addEventListener('click', ()=> shoot());
leftBtn.addEventListener('pointerdown', ()=> keys.left=true);
leftBtn.addEventListener('pointerup', ()=> keys.left=false);
rightBtn.addEventListener('pointerdown', ()=> keys.right=true);
rightBtn.addEventListener('pointerup', ()=> keys.right=false);
shootBtn.addEventListener('click', ()=> shoot());

function shoot(){
  const now=Date.now();
  if(now-lastShot<160) return;
  lastShot=now;
  bullets.push({x:player.x+player.w/2-2,y:player.y-6,w:4,h:6,vy:4.6});
  playShot();
}

function endGame(won){
  roundActive=false;
  if(score>bestScore){ bestScore=score; localStorage.setItem("bestScore",bestScore); }
  updateUI();
  startOverlay.style.display='flex';
  startOverlay.querySelector('.title').innerText=won?'VocÃª venceu! ðŸŽ‰':'Fim de Jogo';
  startOverlay.querySelector('.small').innerText=`PontuaÃ§Ã£o: ${score}`;
  startBtn.innerText='Jogar de novo';
}

function update(){
  if(keys.left) player.x-=player.speed;
  if(keys.right) player.x+=player.speed;
  player.x=clamp(player.x,4,W-player.w-4);

  for(let i=bullets.length-1;i>=0;i--){
    bullets[i].y-=bullets[i].vy;
    if(bullets[i].y+bullets[i].h<0) bullets.splice(i,1);
  }

  if(roundActive){
    for(let i=blocks.length-1;i>=0;i--){
      blocks[i].y+=blocks[i].vy;
      if(blocks[i].y+blocks[i].h>=H-4){
        if(blocks[i].val===question.answer){
          score-=1; updateUI(); showFeedback('-1','#f99'); playMiss();
          roundActive=false; blocks.length=0;
          setTimeout(()=>{ if(score>=WIN_SCORE) endGame(true); else if(score<=LOSE_SCORE) endGame(false); else spawnNextRound(); },700);
          break;
        } else blocks.splice(i,1);
      }
    }
  }

  for(let bi=blocks.length-1;bi>=0;bi--){
    const block=blocks[bi];
    for(let ii=bullets.length-1;ii>=0;ii--){
      const b=bullets[ii];
      if(rectIntersect(b,block)){
        bullets.splice(ii,1); blocks.splice(bi,1);
        if(block.val===question.answer){ score++; showFeedback('+1','#bfb'); playHit(); }
        else { score--; showFeedback('-1','#fbb'); playMiss(); }
        updateUI();
        roundActive=false;
        setTimeout(()=>{ if(score>=WIN_SCORE) endGame(true); else if(score<=LOSE_SCORE) endGame(false); else spawnNextRound(); },600);
        bi=blocks.length; break;
      }
    }
  }

  draw();
  requestAnimationFrame(update);
}

function draw(){
  ctx.fillStyle='#071122'; ctx.fillRect(0,0,W,H);
  for(const block of blocks){
    ctx.fillStyle='#2ea6ff'; ctx.fillRect(Math.round(block.x),Math.round(block.y),block.w,block.h);
    ctx.strokeStyle='#063a52'; ctx.strokeRect(Math.round(block.x),Math.round(block.y),block.w,block.h);
    ctx.fillStyle='#001'; ctx.font='10px monospace'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(String(block.val),Math.round(block.x+block.w/2),Math.round(block.y+block.h/2)+1);
  }
  ctx.fillStyle='#ffd166'; ctx.fillRect(Math.round(player.x),Math.round(player.y),player.w,player.h);
  ctx.fillStyle='#ff9f3a'; ctx.fillRect(Math.round(player.x+6),Math.round(player.y-4),8,4);
  ctx.fillStyle='#fff'; for(const b of bullets) ctx.fillRect(Math.round(b.x),Math.round(b.y),b.w,b.h);
}

startBtn.addEventListener('click', ()=>{
  playMusic();
  startOverlay.style.display='none';
  score=0; bullets.length=0; blocks.length=0; player.x=W/2-player.w/2;
  spawnNextRound();
});

updateUI();
requestAnimationFrame(update);
</script>
</body>
</html>